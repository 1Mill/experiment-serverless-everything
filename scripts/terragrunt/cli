#!/usr/bin/env bash
set -e

function cli() {
	# * Props
	local terraform_version=$1
	local command=${@:2}

	# * Computed helpers
	local script_root=$(dirname $BASH_SOURCE)
	local project_root=$PWD/$script_root/../../ # * Must be absolute path for Docker Volume

	# * Load CLI environmental variables
	source $script_root/config

	# * Load .env from project root into the environment if it exists
	local env_file=$project_root/$ENV_FILENAME
	if [[ -f "$env_file" ]]; then
		source $env_file
	fi

	# * Computed props
	local docker_image=alpine/terragrunt:$terraform_version
	local docker_command="terragrunt $command --terragrunt-exclude-dir ./"

	AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
	AWS_REGION=$AWS_REGION \
	AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
	GITHUB_TOKEN=$GITHUB_TOKEN \
	COMMAND=$docker_command \
	DIR=$project_root \
	DOCKER_IMAGE=$docker_image \
	docker compose \
		--file $script_root/docker-compose.yml \
		up \
			--exit-code-from terragrunt \
			terragrunt
}

cli ${@:1} # * Pass through all arguments to function
