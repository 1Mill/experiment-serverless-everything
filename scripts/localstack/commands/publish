#!/usr/bin/env bash
set -e

function publish() {
	# * Props
	local path=$1

	# * Load environmental variables
	# ! The environmental variables file must be loaded first
	# ! so that the config file can use its values later on
	local env_path=$(pwd)/$path/$LAMBDA_ENV_FILENAME
	if [ -f "$env_path" ]; then
		source $env_path
	fi

	# * Load config variables into environment
	local config_path=$(pwd)/$path/$LAMBDA_CONFIG_FILENAME
	source $config_path

	# * Computed values
	local dev_env=${DEV_ENV-"{}"}
	local name=$NAME
	local timeout=$TIMEOUT

	# * Run command
	aws lambda delete-function \
		--endpoint $LOCALSTACK_URL \
		--function-name $name \
		--no-cli-pager \
		--region $LOCALSTACK_REGION || true # ! Do not error when function is not found

	aws lambda create-function \
		--code ImageUri=$name \
		--endpoint $LOCALSTACK_URL \
		--function-name $name \
		--no-cli-pager \
		--package-type Image \
		--region $LOCALSTACK_REGION \
		--role arn:aws:iam::000000000:role/lambda-placeholder \
		--timeout $timeout

	aws lambda update-function-configuration \
		--endpoint $LOCALSTACK_URL \
		--environment "Variables=$dev_env" \
		--function-name $name \
		--no-cli-pager \
		--region $LOCALSTACK_REGION
}

publish $1
